<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HygienSense Live Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f0f2f5;
  text-align: center;
}

.container {
  width: 95%;
  max-width: 1100px;
  margin: auto;
}

h1 {
  margin-top: 20px;
}

.ampel {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  margin: 25px auto;
  background: gray;
  box-shadow: 0 0 30px rgba(0,0,0,0.3);
  transition: 0.4s;
}

.status {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
}

.dataBox {
  font-size: 18px;
  margin-bottom: 20px;
}

canvas {
  background: white;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 30px;
}

.chartRow {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-top: 30px;
}

.smallChart {
  width: 320px;
  height: 240px;
  background: white;
  border-radius: 10px;
  padding: 5px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
</style>
</head>

<body>
<div class="container">

<h1>HygienSense â€“ Weltweiter Live Status</h1>

<div class="ampel" id="ampel"></div>
<div class="status" id="statusText">Lade Daten...</div>

<div class="dataBox">
Temperatur: <span id="temp">-</span> Â°C |
Feuchte: <span id="hum">-</span> % |
H-Wert: <span id="hval">-</span>
</div>

<canvas id="chart"></canvas>

<h2>ThingSpeak Detailcharts</h2>

<div class="chartRow">

<div class="smallChart">
<iframe width="300" height="220"
style="border: 1px solid #cccccc;"
src="https://thingspeak.com/channels/3269860/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true">
</iframe>
</div>

<div class="smallChart">
<iframe width="300" height="220"
style="border: 1px solid #cccccc;"
src="https://thingspeak.com/channels/3269860/charts/2?bgcolor=%23ffffff&color=%230080ff&dynamic=true">
</iframe>
</div>

<div class="smallChart">
<iframe width="300" height="220"
style="border: 1px solid #cccccc;"
src="https://thingspeak.com/channels/3269860/charts/3?bgcolor=%23ffffff&color=%2300aa00&dynamic=true">
</iframe>
</div>

</div>

</div>

<script>
const channelID = "3269860";
const readAPI = "X9AKA84YA0HVK2SM";

let chart;

async function loadData() {
  const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPI}&results=30`;
  const response = await fetch(url);
  const data = await response.json();

  const feeds = data.feeds;

  let labels = [];
  let Hvalues = [];
  let lastH = 0;
  let lastTemp = 0;
  let lastHum = 0;

  feeds.forEach(feed => {
    labels.push(new Date(feed.created_at).toLocaleTimeString());
    Hvalues.push(parseFloat(feed.field3));
  });

  if (feeds.length > 0) {
    lastH = parseFloat(feeds[feeds.length - 1].field3);
    lastTemp = parseFloat(feeds[feeds.length - 1].field1);
    lastHum = parseFloat(feeds[feeds.length - 1].field2);
  }

  document.getElementById("temp").innerText = lastTemp.toFixed(1);
  document.getElementById("hum").innerText = lastHum.toFixed(1);
  document.getElementById("hval").innerText = lastH.toFixed(4);

  updateAmpel(lastH);
  updateChart(labels, Hvalues);
}

function updateAmpel(H) {
  const ampel = document.getElementById("ampel");
  const statusText = document.getElementById("statusText");

  if (H >= 1.0) {
    ampel.style.background = "red";
    statusText.innerHTML = "ðŸ”´ KEIMUNG ERREICHT";
  } 
  else if (H >= 0.8) {
    ampel.style.background = "yellow";
    statusText.innerHTML = "ðŸŸ¡ WARNBEREICH";
  } 
  else {
    ampel.style.background = "green";
    statusText.innerHTML = "ðŸŸ¢ UNKRITISCH";
  }
}

function updateChart(labels, data) {
  const ctx = document.getElementById("chart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "H-Wert Verlauf",
        data: data,
        borderColor: "blue",
        borderWidth: 2,
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          min: 0,
          max: 1
        }
      }
    }
  });
}

loadData();
setInterval(loadData, 20000);
</script>

</body>
</html>
